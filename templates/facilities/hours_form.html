{% extends "base.html" %}
{% block title %}{% if hours %}Edit{% else %}Add{% endif %} hours – RinkRent{% endblock %}
{% block content %}
<div class="max-w-2xl">
  <h1 class="text-2xl font-bold mb-2">{% if hours %}Edit hours{% else %}Add hours of operation{% endif %} – {{ surface.name }}</h1>
  {% if add_flow %}
  <p class="text-sm text-base-content/70 mb-6">Select one or more days and set open/close times. The same times apply to all selected days. Existing hours for other days are unchanged.</p>
  {% endif %}

  <form method="post" class="card bg-base-200 shadow" id="hours-form">
    <div class="card-body">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-error text-sm mb-4">{{ form.non_field_errors.0 }}</div>
      {% endif %}

      {% if add_flow %}
      <div class="form-control mb-4">
        <label class="label font-medium">Days</label>
        <div class="flex flex-wrap gap-4 items-center">
          {% for field, label in weekday_fields %}
            <label class="flex items-center gap-2 cursor-pointer">
              {{ field }}
              <span class="text-sm">{{ label }}</span>
            </label>
          {% endfor %}
          <span class="text-base-content/50 text-sm">|</span>
          <button type="button" id="select-weekdays" class="btn btn-ghost btn-xs">Weekdays</button>
          <button type="button" id="select-weekends" class="btn btn-ghost btn-xs">Weekends</button>
          <button type="button" id="select-all" class="btn btn-ghost btn-xs">All</button>
          <button type="button" id="select-none" class="btn btn-ghost btn-xs">None</button>
        </div>
      </div>

      <div class="form-control mb-2">
        <label class="label font-medium" for="id_open_time">Open / close time</label>
        <p class="text-xs text-base-content/60 mb-3">Choose from 30-minute options or drag the sliders.</p>
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-3 flex-wrap">
            <label class="text-xs font-medium text-base-content/70 w-12" for="id_open_time">Open</label>
            {{ form.open_time }}
            <input type="range" min="0" max="48" value="12" id="range-open" class="range range-primary range-sm flex-1 max-w-xs" title="Open time">
          </div>
          <div class="flex items-center gap-3 flex-wrap">
            <label class="text-xs font-medium text-base-content/70 w-12" for="id_close_time">Close</label>
            {{ form.close_time }}
            <input type="range" min="0" max="48" value="44" id="range-close" class="range range-primary range-sm flex-1 max-w-xs" title="Close time">
          </div>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-base-content/50 w-8">12a</span>
            <div class="flex-1 h-3 bg-base-300 rounded-full relative overflow-hidden" id="time-track">
              <div class="absolute inset-y-0 rounded-full bg-primary/40 transition-all" id="time-range-fill"></div>
            </div>
            <span class="text-[10px] text-base-content/50 w-8">12a</span>
          </div>
        </div>
        {% if form.open_time.errors %}<p class="text-error text-sm mt-1">{{ form.open_time.errors.0 }}</p>{% endif %}
        {% if form.close_time.errors %}<p class="text-error text-sm mt-1">{{ form.close_time.errors.0 }}</p>{% endif %}
      </div>
      {% else %}
      {% for field in form %}
        <div class="form-control{% if field.name == 'open_time' or field.name == 'close_time' %} flex flex-wrap items-end gap-2{% endif %}">
          <label class="label{% if field.name == 'open_time' or field.name == 'close_time' %} w-full{% endif %}" for="{{ field.id_for_label }}">{{ field.label }}</label>
          <div class="flex gap-2 flex-wrap">{{ field }}</div>
          {% if field.errors %}<p class="text-error text-sm w-full">{{ field.errors.0 }}</p>{% endif %}
        </div>
      {% endfor %}
      {% endif %}

      <div class="card-actions justify-end mt-6">
        <a href="{% url 'facilities:hours_list' surface.pk %}" class="btn btn-ghost">Cancel</a>
        <button type="submit" class="btn btn-primary">{% if add_flow %}Apply to selected days{% else %}Save{% endif %}</button>
      </div>
    </div>
  </form>

  <p class="mt-4"><a href="{% url 'facilities:hours_list' surface.pk %}" class="link text-sm">← Back to hours list</a></p>
</div>

{% if add_flow %}
{% block extra_js %}
<script>
(function() {
  var form = document.getElementById('hours-form');
  var openTime = document.getElementById('id_open_time');
  var closeTime = document.getElementById('id_close_time');
  var rangeOpen = document.getElementById('range-open');
  var rangeClose = document.getElementById('range-close');
  var fill = document.getElementById('time-range-fill');

  function slotToTime(slot) {
    var h = Math.floor(slot / 2);
    var m = (slot % 2) * 30;
    return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':00';
  }
  function timeToSlot(value) {
    if (!value) return 0;
    var parts = value.split(':');
    var h = parseInt(parts[0], 10) || 0;
    var m = parseInt(parts[1], 10) || 0;
    return Math.min(48, Math.round((h * 2) + (m / 30)));
  }

  function updateFill() {
    var o = parseInt(rangeOpen.value, 10);
    var c = parseInt(rangeClose.value, 10);
    if (o > c) { var t = o; o = c; c = t; rangeOpen.value = o; rangeClose.value = c; }
    var pctOpen = (o / 48) * 100;
    var pctClose = (c / 48) * 100;
    fill.style.left = pctOpen + '%';
    fill.style.width = (pctClose - pctOpen) + '%';
    openTime.value = slotToTime(o).slice(0, 5);
    closeTime.value = slotToTime(c).slice(0, 5);
  }

  function fromTimeInputs() {
    rangeOpen.value = timeToSlot(openTime.value);
    rangeClose.value = timeToSlot(closeTime.value);
    updateFill();
  }

  rangeOpen.addEventListener('input', updateFill);
  rangeClose.addEventListener('input', updateFill);
  openTime.addEventListener('change', fromTimeInputs);
  closeTime.addEventListener('change', fromTimeInputs);

  rangeOpen.value = timeToSlot(openTime.value);
  rangeClose.value = timeToSlot(closeTime.value);
  updateFill();

  var dayBoxes = form.querySelectorAll('.add-day');
  document.getElementById('select-weekdays').addEventListener('click', function() {
    dayBoxes.forEach(function(cb, i) { cb.checked = (i >= 0 && i <= 4); });
  });
  document.getElementById('select-weekends').addEventListener('click', function() {
    dayBoxes.forEach(function(cb, i) { cb.checked = (i === 5 || i === 6); });
  });
  document.getElementById('select-all').addEventListener('click', function() {
    dayBoxes.forEach(function(cb) { cb.checked = true; });
  });
  document.getElementById('select-none').addEventListener('click', function() {
    dayBoxes.forEach(function(cb) { cb.checked = false; });
  });
})();
</script>
{% endblock %}
{% endif %}
{% endblock %}
