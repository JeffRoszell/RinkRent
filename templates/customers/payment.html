{% extends "base.html" %}
{% block title %}Payment – RinkRent{% endblock %}
{% block content %}
<div class="max-w-lg card bg-base-200 shadow">
  <div class="card-body">
    <h1 class="card-title">Complete payment</h1>
    <p class="opacity-80">Enter your card details below to pay for your booking.</p>
    <div id="payment-element" class="mt-4 min-h-[120px]">Loading…</div>
    <div id="payment-message" class="text-error mt-2 hidden"></div>
    <button type="button" id="submit" class="btn btn-primary mt-4" disabled>Loading…</button>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  (function() {
    const clientSecret = "{{ client_secret|escapejs }}";
    const publishableKey = "{{ stripe_publishable_key|escapejs }}";
    const returnUrl = "{{ request.scheme }}://{{ request.get_host }}{% url 'customers:my_bookings' %}";
    const receiptEmail = "{{ user.email|escapejs }}";

    const msgEl = document.getElementById('payment-message');
    const submitBtn = document.getElementById('submit');
    const containerEl = document.getElementById('payment-element');

    function showError(msg) {
      msgEl.textContent = msg || 'Payment not configured.';
      msgEl.classList.remove('hidden');
      containerEl.innerHTML = '';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Pay now';
    }

    if (!clientSecret || !publishableKey) {
      showError('Payment not configured. Your booking is confirmed—see My bookings.');
      return;
    }

    function init() {
      if (typeof Stripe === 'undefined') {
        showError('Payment form could not load. Your booking is confirmed—see My bookings.');
        return;
      }
      const stripe = Stripe(publishableKey);
      const elements = stripe.elements({ clientSecret });
      const paymentElement = elements.create('payment');
      paymentElement.mount('#payment-element');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Pay now';
      submitBtn.onclick = async function() {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing…';
        msgEl.classList.add('hidden');
        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: returnUrl,
            receipt_email: receiptEmail || undefined,
          },
        });
        if (error) {
          msgEl.textContent = error.message || 'Payment failed.';
          msgEl.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Pay now';
        }
      };
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
{% endblock %}
