{% extends "base.html" %}
{% block title %}Find ice – RinkRent{% endblock %}
{% block content %}
<div class="flex flex-col gap-8 max-w-2xl mx-auto">
  <div class="text-center space-y-2">
    <h1 class="text-3xl font-bold tracking-tight">Find ice time</h1>
    <p class="text-base-content/70 text-sm">Search rinks in your area. Use your location to sort by distance.</p>
  </div>

  <div class="rounded-2xl bg-base-200/80 border border-base-300 p-5 shadow-sm">
    <form method="get" id="search-form" class="flex flex-col gap-3">
      <input type="hidden" name="lat" id="lat" value="{{ lat }}">
      <input type="hidden" name="lng" id="lng" value="{{ lng }}">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-stretch">
        <input type="text" name="q" placeholder="City, address, or postal code (optional)" class="input input-bordered flex-1 min-w-0 input-sm sm:input-md" value="{{ request.GET.q }}" aria-label="Search location">
        <div class="flex gap-2 flex-shrink-0 sm:flex-nowrap">
          <button type="button" id="use-location" class="btn btn-outline btn-sm flex-1 sm:flex-none whitespace-nowrap gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Use my location
          </button>
          <button type="submit" class="btn btn-primary btn-sm flex-1 sm:flex-none">Search</button>
        </div>
      </div>
    </form>
  </div>

  <section class="space-y-1" aria-label="Search results">
    {% for f, distance_km in facility_list %}
      <a href="{% url 'customers:facility_detail' f.pk %}" class="block rounded-xl border border-base-300 bg-base-100 p-4 pr-5 shadow-sm hover:shadow-md hover:border-primary/30 hover:bg-base-200/50 transition-all duration-200 border-l-4 border-l-primary group">
        <div class="flex flex-wrap items-start justify-between gap-2">
          <div class="min-w-0 flex-1">
            <h2 class="font-semibold text-lg text-base-content group-hover:text-primary">{{ f.name }}</h2>
            <p class="text-sm text-base-content/70 mt-0.5">{{ f.get_full_address|default:"No address" }}</p>
            <div class="flex flex-wrap items-center gap-2 mt-2">
              <span class="badge badge-ghost badge-sm">{{ f.ice_surfaces.count }} surface{{ f.ice_surfaces.count|pluralize }}</span>
              {% if distance_km is not None %}
                <span class="text-xs text-base-content/60">{{ distance_km }} km away</span>
              {% endif %}
              {% for amenity in f.get_amenities_list %}
                <span class="badge badge-outline badge-sm">{{ amenity }}</span>
              {% endfor %}
            </div>
          </div>
          <span class="text-base-content/50 group-hover:text-primary shrink-0 transition-colors" aria-hidden="true">→</span>
        </div>
      </a>
    {% empty %}
      <div class="rounded-xl border border-dashed border-base-300 bg-base-200/50 p-8 text-center">
        <p class="text-base-content/70">No rinks found.</p>
        <p class="text-sm text-base-content/60 mt-1">Try a different search or use “Use my location” to see rinks near you.</p>
      </div>
    {% endfor %}
  </section>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
  var form = document.getElementById('search-form');
  var latInput = document.getElementById('lat');
  var lngInput = document.getElementById('lng');
  var useBtn = document.getElementById('use-location');
  if (!form || !latInput || !lngInput || !useBtn) return;
  var useBtnHtml = useBtn.innerHTML;
  useBtn.addEventListener('click', function() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }
    useBtn.disabled = true;
    useBtn.innerHTML = 'Getting location…';
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        latInput.value = pos.coords.latitude;
        lngInput.value = pos.coords.longitude;
        form.submit();
      },
      function() {
        alert('Could not get location.');
        useBtn.disabled = false;
        useBtn.innerHTML = useBtnHtml;
      }
    );
  });
})();
</script>
{% endblock %}
